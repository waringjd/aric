---
title: "ARIC Project"
author: "Anish Shah"
date: "February 27th, 2018"
output: 
  pdf_document: 
    highlight: tango
editor_options: 
  chunk_output_type: console
---

```{r setup, global_options, include=FALSE}

knitr::opts_chunk$set(
  cache = FALSE,
  warning = TRUE,
  echo = FALSE,
  message = FALSE,
  results = "asis"
)
```


# INTRODUCTION

## Hypothesis

Our study goal is to examine 2-minute high frequency heart rate variability (V1, V4) and the longitudinal relationship with anger (V2, V4) and the cross-sectional relationship with vital exhaustion and social support (V2). We expect that a low heart rate variability will correlate with increased anger, increased exhaustion, and decreased social support. In addition, we expect that an improvement over the course of follow-up in the psychosocial state of anger will result in an increased heart rate variability.

## Version control

0.1.0 Wrangle data intake first
0.2.0 Wrangle tidy the data

## Libraries

Required libraries for this R project.

```{r}

library(tidyverse)
library(lubridate)
library(rio)
library(broom)
library(compareGroups)
```

# INTAKE

All the files were taken from the shared ARIC drive from RSPH. They were initially in SAS format, and converted to an *dat* file. The README file has definitions of variables selected and further details.

## Visit 1 data

Demograph data from visit 1.

```{r}

# Read in table
v1d <- read_csv("v1/DERIVE13.dat", col_names = TRUE)

# Select only important columns
svar <- c(
  "ID",
  "DRNKR01",
  "BMI01",
  "PRVCHD05",
  "MDDXMI02",
  "PREVMI05",
  "HXOFMI02",
  "DIABTS03",
  "HYPERT05",
  "HYPTMD01",
  "CHOLMDCODE01",
  "V1AGE01",
  "V1DATE01",
  "BIRTHDAT",
  "GENDER",
  "RACEGRP",
  "PLAQUE01",
  "CIGT01",
  "CIGTYR01"
)
v1d <- v1d[c(svar)]

# Format data
v1d$V1DATE01 <- dmy(v1d$V1DATE01)
v1d$BIRTHDAT <- dmy(v1d$BIRTHDAT)

```

## Visit 2 data

Visit 2 prevalence data, although there is some attrition.

```{r}

## Derived variables

# Selected variables
svar <- c(
  "ID",
  "DRNKR21",
  "BMI21",
  "PRVCHD21",
  "MDDXMI21",
  "HXOFMI21",
  "DIABTS23",
  "ECGMI24",
  "PRVSTR21",
  "HYPERT25",
  "HYPTMD21",
  "CHOLMDCODE21",
  "V2AGE22",
  "V2DATE21",
  "PLAQUE21",
  "CIGT21"
)

# Intake and format variables
v2d <- read_csv("v2/DERIVE2_10.dat", col_names = TRUE)
v2d <- v2d[c(svar)]
v2d$V2DATE21 <- dmy(v2d$V2DATE21)

## Intake of V2 psychosocial metrics (Health and Life Profile).

# Social support
hpa2 <- read_csv("v2/HPAA.dat", col_names = TRUE)
hpa2$HPAA30 <- dmy(hpa2$HPAA30)

# Vital exhaustion
hpb2 <- read_csv("v2/HPBA.dat", col_names = TRUE)
hpb2$HPBA22 <- dmy(hpb2$HPBA22)

# Spielberger anger trait
hpc2 <- read_csv("v2/HPCA.dat", col_names = TRUE)
hpc2$HPCA11 <- dmy(hpc2$HPCA11)
```

## Visit 4 data

This is a prevalance data from the time of visit 4.

```{r}

## Derived variables from visit 4

# Selected variables.
svar <- c(
  "ID",
  "DRNKR41",
  "BMI41",
  "PRVCHD43",
  "MDDXMI41",
  "HXOFMI41",
  "DIABTS42",
  "ECGMI41",
  "PRVSTR41",
  "HYPERT45",
  "HYPTMD41",
  "CHOLMDCODE41",
  "V4AGE41",
  "V4DATE41",
  "PLAQUE42",
  "CIGT41"
)


v4d <- read_csv("v4/DERIVE46.dat", col_names = TRUE)
v4d <- v4d[c(svar)]
v4d$V4DATE41 <- dmy(v4d$V4DATE41)

## Psychosocial metric

# Spielberger anger trait at visit 4.
hpc4 <- read_csv("v4/HPCB04.dat", col_names = TRUE)
hpc4$HPCB11 <- dmy(hpc4$HPCB11)
```



## HRV data

This is a complicated data set of HRV files given to us by Eric Whitsel from the ARIC group. It has HRV data from visit 1 and from visit 4.

```{r}

## Data from HRV from visit 1, supine data.
hrv1 <- read_csv("hrv/f_hrv11b.dat", col_names = TRUE)

# Variables
svar <- c(
		  "ID",
		  "POSTV11",
		  "QCFLGV11",
		  "M_HRV11",
		  "HFV11",
		  "LFV11",
		  "VLFV11",
		  "TPV11",
		  "PNN50V11",
		  "MSSDV11",
		  "SDNNV11"
		  )
hrv1 <- hrv1[c(svar)]

## HRV data from visit 4.
hrv4 <- read_csv("hrv/hrv_re4f.dat", col_names = TRUE)

# Selected variables
svar <- c(
		  "ID",
		  "postV4r",
		  "qcflgv4R",
		  "m_hrv4r",
		  "HFv4r",
		  "LFv4r",
		  "VLFv4r",
		  "tpV4r",
		  "mssdV4r",
		  "pnn50V4r",
		  "sdnnV4r"
		  )
hrv4 <- hrv4[c(svar)]

```


## Outcomes data

An additional file of outcomes that were recorded (mainly death and associated ICD codes) along with if a cardiovascular event had occurred. This was updated for all patients up to the year 2015.

```{r}

# Read in table
outcomes <- read_csv("outcomes/inc_by15.dat", col_names = TRUE)

# Select and trim data frame
svar <- c(
  "ID",
  "C7_DATEMI",
  "C7_DATEPROC",
  "UCOD",
  "DATED15",
  "DEAD15"
)
outcomes <- outcomes[c(svar)]

outcomes$C7_DATEMI <- mdy(outcomes$C7_DATEMI)
outcomes$C7_DATEPROC <- mdy(outcomes$C7_DATEPROC)
outcomes$DATED15 <- dmy(outcomes$DATED15)

```

# TIDY

## Demographics

Creating a file that contains the basic demographic data of all patients along with their overall outcomes. The file is stored in *demo*, as a tidy tibble.

```{r}

# Demographic data: birthday, gender, race
# Combine this with the outcomes data
svar <- c("ID", "V1DATE01", "BIRTHDAT", "GENDER", "RACEGRP")
demo <- as_tibble(merge(v1d[c(svar)], outcomes, by = "ID"))
```

## Visit 2

### Cross-sectional covariate data

Limit the covariates to the most relevant, particularly prevalence of coronary artery disease (using myocardial ischemia or damage as the measurement). 

```{r}

## Visit 2 cross-sectional data

# Will need to include BMI, drinking status, coronary disease, diabetes, CVA, hypertension, smoking status
cs2 <- v2d

# BMI
cs2$BMI_2 <- round(cs2$BMI21, digits = 1)
cs2$BMI_2cat <- cut(cs2$BMI21,
  breaks = c(-Inf, 18.5, 25, 30, 35, 40, Inf),
  labels = c("underweight", "normal", "overweight", "obese_mild", "obese_moderate", "obese_severe")
)

# Diagnosis of hypertension, including treatment.
cs2$HTN_2 <- 0
cs2$HTN_2[v2d$HYPERT25 == 1 | v2d$HYPTMD21 == 1] <- 1

# Prior coronary artery disease by any known disease, MD decision, or ECG findings of Q waves.
cs2$CHD_2 <- 0
cs2$CHD_2[(v2d$PRVCHD21 | v2d$MDDXMI21 | v2d$ECGMI24) == 1] <- 1

svar <- c("ID", "V2DATE21", "V2AGE22", "DRNKR21", "CIGT21", "BMI_2", "BMI_2cat", "HTN_2", "CHD_2", "DIABTS23", "PRVSTR21")

cs2 <- as_tibble(cs2[c(svar)])

# Add demographic information in
cs2 <- merge(demo, cs2, by = "ID")

# Clean up
rm(svar)
```


### Psychosocial metrics

#### HPAA

The ISEL is scored from 0-3 points per question for 16-items, with the total ranging from 0-48 points (higher being more supportive). There are subscales, which are seen below as they map on to the HPAA questions.

Variable | Questions
--- | ---
AP | 7, 10, 14, 17 
TA | 8, 9, 13, 16
BE | 4, 5, 6, 11, 18
SE | 3, 12, 15

The LSNS is scored from 0-5 points for an 10-item questionnaire (the original form), with the total ranging from 0-50 points (higher more supportive). The subscales haven't been validated.

```{r}

# Select social support data
df <- hpa2

# ISEL is 3:18
# LSNS is 19:29

# ISEL variables
isel <- c("HPAA03", "HPAA04", "HPAA05", "HPAA06", "HPAA07", "HPAA08", "HPAA09", "HPAA10", "HPAA11", "HPAA12", "HPAA13", "HPAA14", "HPAA15", "HPAA16", "HPAA17", "HPAA18")

# LSNS variables
lsns <- c("HPAA19", "HPAA20", "HPAA21", "HPAA22", "HPAA23", "HPAA24", "HPAA25", "HPAA26", "HPAA27", "HPAA28", "HPAA29")

# Class of variables

# Trimmed HPAA data
df$placeholder <- NA
df <- df[c("ID", "placeholder", isel, lsns)]


# Create factors for ISEL
# Positive factors (higher score is better)
df[c(3, 6, 7, 8, 11, 12, 13, 14, 16, 18)] <- 
  df[c(3, 6, 7, 8, 11, 12, 13, 14, 16, 18)] %>%
  mutate_all(funs(recode(., "A" = 0, "B" = 1, "C" = 2, "D" = 3)))

# Negative or reversed choices
df[c(4, 5, 9, 10, 15, 17)] <- 
  df[c(4, 5, 9, 10, 15, 17)] %>%
  mutate_all(funs(recode(., "A" = 3, "B" = 2, "C" = 1, "D" = 0)))

# Create factors and scores for LSNS
df[c(19, 20, 21, 22, 23, 24)] <- 
  df[c(19, 20, 21, 22, 23, 24)] %>%
  mutate_all(funs(recode(., "A" = 0, "B" = 1, "C" = 2, "D" = 3, "E" = 4, "F" = 5)))

df[c(25, 26)] <- 
  df[c(25, 26)] %>%
  mutate_all(funs(recode(., "A" = 5, "B" = 4, "C" = 3, "D" = 2, "E" = 1, "F" = 0)))

df <- within(df, {
  HPAA27 <- recode(HPAA27, "A" = 1, "B" = 0)
  HPAA28 <- recode(HPAA28, "B" = 5, "C" = 4, "D" = 3, "E" = 2, "F" = 1)
  HPAA29 <- recode(HPAA29, "A" = 4, "B" = 3, "C" = 2, "D" = 1)
})

# Summarize data based on scale
df$ISEL <- rowSums(df[c(3:18)], na.rm = TRUE)
df$LSNS <- rowSums(df[c(19:29)], na.rm = TRUE)

# Summarize data with ISEL subscales
df$AP <- rowSums(df[c(7, 10, 14, 17)], na.rm = TRUE)
df$TA <- rowSums(df[c(8, 9, 13, 16)], na.rm = TRUE)
df$BE <- rowSums(df[c(4, 5, 6, 11, 18)], na.rm = TRUE)
df$SE <- rowSums(df[c(3, 12, 15)], na.rm = TRUE)

# Place data back
hpa2 <- df
```

#### HPBA

This is using the Maastricht Vital Exhaustion Questionnaire.

```{r}

# Maastrich data
df <- hpb2

# HPBA variable set up (questions number align)
questions <- c("HPBA01", "HPBA02", "HPBA03", "HPBA04", "HPBA05", "HPBA06", "HPBA07", "HPBA08", "HPBA09", "HPBA10", "HPBA11", "HPBA12", "HPBA13", "HPBA14", "HPBA15", "HPBA16", "HPBA17", "HPBA18", "HPBA19", "HPBA20", "HPBA21")
df <- df[c(questions, "ID")]

# Mutate to scores
df[c(1:8, 10:13, 15:21)] <- 
  df[c(1:8, 10:13, 15:21)] %>%
  mutate_all(funs(recode(., "Y" = 2, "D" = 1, "N" = 0)))

# Reversed scores
df[c(9, 14)] <- 
  df[c(9, 14)] %>%
  mutate_all(funs(recode(., "Y" = 0, "D" = 1, "N" = 2)))

df$MAASTRICH <- rowSums(df[c(1:21)], na.rm = TRUE)

# Place data back
hpb2 <- df
```


#### HPCB

```{r}

# HPC2 data frame
df <- hpc2

# Create data frame from Maastrich, trimmed down
questions <- c("HPCA01", "HPCA02", "HPCA03", "HPCA04", "HPCA05", "HPCA06", "HPCA07", "HPCA08", "HPCA09", "HPCA10")
df <- df[c(questions, "ID")]

# Mutate scores, with low = 1, high = 4
df[c(1:10)] <-
  df[c(1:10)] %>%
  mutate_all(funs(recode(., "A" = 1, "B" = 2, "C" = 3, "D" = 4)))

# Create total score
df$SPIELBERGER <- rowSums(df[c(1:10)], na.rm = TRUE)

# Create strata defined as high = [22, 40], mid = [15, 21], low = [10,14]
# Variable "anger_level" shows the three strata (low = 1, mid = 2, high = 3)

df$anger_level <- 1
df$anger_level[df$SPIELBERGER >= 15] <- 2
df$anger_level[df$SPIELBERGER >= 22] <- 3

# Confirm data frame
hpc2 <- df
```


### HRV metrics (collected at visit 1)

This is the 2 minute data collection done supine. 

```{r}

# Visit 1 HRV data
df <- hrv1

# Variables and data trim
svar <- c(
  "ID",
  "M_HRV11",
  "HFV11",
  "LFV11",
  "VLFV11",
  "TPV11",
  "PNN50V11",
  "MSSDV11",
  "SDNNV11"
)
df <- df[c("QCFLGV11", svar)]

# Only "quality" data
df <- df[df$QCFLGV11 != 1, svar]

# Rename the columns for ease of use
names(df) <- c("ID", "BPM", "HF", "LF", "VLF", "TP", "PNN50", "RMSSD", "SDNN")


# Only quality HRV data
hrv1 <- df

```



## Visit 4

### Cross sectional data

Adjusted multiple variables for more meaningful interpretation.

```{r}

# Make cross sectional data table
cs4 <- v4d

# Fix BMI
cs4$BMI_4 <- round(cs4$BMI41, digits = 1)
cs4$BMI_4cat <- cut(cs4$BMI41,
  breaks = c(-Inf, 18.5, 25, 30, 35, 40, Inf),
  labels = c("underweight", "normal", "overweight", "obese_mild", "obese_moderate", "obese_severe")
)

# Fix hypertension
cs4$HTN_4 <- 0
cs4$HTN_4[v4d$HYPERT45 == 1 | v4d$HYPTMD41 == 1] <- 1

# Prior coronary artery disease by any known disease, MD decision, or ECG findings of Q waves.
cs4$CHD_4 <- 0
cs4$CHD_4[(v4d$PRVCHD43 | v4d$MDDXMI41 | v4d$ECGMI41) == 1] <- 1

# Select variables
svar <- c("ID", "V4AGE41", "V4DATE41", "DRNKR41", "CIGT41", "CHD_4", "HTN_4", "BMI_4", "BMI_4cat", "DIABTS42", "PRVSTR41")
cs4 <- cs4[c(svar)]

# Clean up data set
rm(svar)
```

### Psychosocial metric


#### HPCB

```{r}

# HPCB data frame from visit 4
df <- hpc4

# Create data frame from Maastrich, trimmed down
questions <- c("HPCB01", "HPCB02", "HPCB03", "HPCB04", "HPCB05", "HPCB06", "HPCB07", "HPCB08", "HPCB09", "HPCB10")
df <- df[c(questions, "ID")]

# Mutate scores, with low = 1, high = 4
df[c(1:10)] <-
  df[c(1:10)] %>%
  mutate_all(funs(recode(., "A" = 1, "B" = 2, "C" = 3, "D" = 4)))

# Create total score
df$SPIELBERGER <- rowSums(df[c(1:10)], na.rm = TRUE)

# Create strata defined as high = [22, 40], mid = [15, 21], low = [10,14]
# Variable "anger_level" shows the three strata (low = 1, mid = 2, high = 3)

df$anger_level <- 1
df$anger_level[df$SPIELBERGER >= 15] <- 2
df$anger_level[df$SPIELBERGER >= 22] <- 3

# Confirm data frame
hpc4 <- df
```

### HRV metrics

HRV collected at visit 4 was supine and lasted about 6 minutes.

```{r}

# Select data frame
df <- hrv4

# Variable selection
svar <- c(
  "ID", 
  "m_hrv4r", 
  "HFv4r",
  "LFv4r",
  "VLFv4r",
  "tpV4r",
  "pnn50V4r",
  "mssdV4r",
  "sdnnV4r"
)
df <- df[c("qcflgv4R", svar)]

# Only quality data
df <- df[df$qcflgv4R != 1, svar]

# Rename variables
names(df) <- c("ID", "BPM", "HF", "LF", "VLF", "TP", "PNN50", "RMSSD", "SDNN")

# Final data frame

hrv4 <- df

```

## Clean up

```{r}

# Clean up of memory-clogging junk
rm(df, outcomes, questions, svar, v1d, v2d, v4d)
```


