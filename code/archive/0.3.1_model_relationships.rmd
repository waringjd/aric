---
title: "Heart Rate Variability and Psychosocial States"
subtitle: "An Atherosclerotic Risk in Communities Study"
author: 
- Anish Shah, MD^[Department of Medicine, School of Medicine, Emory University]
- Amit Shah, MD, MSCR^[Department of Epidemiology, Rollins School of Public Health, Emory University]
data: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  md_document: 
    highlight: tango
editor_options: 
  chunk_output_type: console
---

```{r setup, global_options, include=FALSE}

knitr::opts_chunk$set(
  cache = FALSE,
  warning = FALSE,
  eval = TRUE,
  echo = FALSE,
  include = TRUE,
  message = FALSE,
  results = "asis",
  dpi = 600,
  dev = "png",
  options("scipen" = 0, "digits" = 4)
)
```

```{r}

start_time <- proc.time()
```


# INTRODUCTION

## Hypothesis

Our study goal is to examine 2-minute high frequency heart rate variability (V1, V4) and the longitudinal relationship with anger (V2, V4) and the cross-sectional relationship with vital exhaustion and social support (V2). We expect that a low heart rate variability will correlate with increased anger, increased exhaustion, and decreased social support. In addition, we expect that an improvement over the course of follow-up in the psychosocial state of anger will result in an increased heart rate variability.


## Version control

0.1.0 Wrangle - data intake first
0.2.0 Wrangle -  tidy the data
0.3.0 Model - data exploration
0.3.1 Model - relatiotionship between variables

## Libraries

Required libraries for this R project.

```{r}

library(stargazer)
library(lubridate)
library(rio)
library(broom)
library(compareGroups)
library(icd)
library(reshape2)
library(ggridges)
library(scales)
library(ggthemes)
library(rcompanion)
library(GGally)
library(psych)
library(Hmisc)
library(RColorBrewer)
library(PerformanceAnalytics)
library(dplyr)
library(survival)
library(survminer)
library(magrittr)
library(tidyverse)
library(knitr)
library(kableExtra)

```

# INTAKE

All the files were taken from the shared ARIC drive from RSPH. They were initially in SAS format, and converted to an *dat* file. The README file has definitions of variables selected and further details.

## Visit 1 data

Demograph data from visit 1.

```{r}

# Read in table
v1d <- read_csv("v1/DERIVE13.dat", col_names = TRUE)

# Select only important columns
svar <- c(
  "ID",
  "DRNKR01",
  "BMI01",
  "PRVCHD05",
  "MDDXMI02",
  "PREVMI05",
  "HXOFMI02",
  "DIABTS03",
  "HYPERT05",
  "HYPTMD01",
  "CHOLMDCODE01",
  "V1AGE01",
  "V1DATE01",
  "BIRTHDAT",
  "GENDER",
  "RACEGRP",
  "PLAQUE01",
  "CIGT01",
  "CIGTYR01"
)
v1d <- v1d[c(svar)]

# Format data
v1d$V1DATE01 <- dmy(v1d$V1DATE01)
v1d$BIRTHDAT <- dmy(v1d$BIRTHDAT)
```


## Visit 2 data

Visit 2 prevalence data, although there is some attrition.

```{r}

## Derived variables

# Selected variables
svar <- c(
  "ID",
  "DRNKR21",
  "BMI21",
  "PRVCHD21",
  "MDDXMI21",
  "HXOFMI21",
  "DIABTS23",
  "ECGMI24",
  "PRVSTR21",
  "HYPERT25",
  "HYPTMD21",
  "CHOLMDCODE21",
  "V2AGE22",
  "V2DATE21",
  "PLAQUE21",
  "CIGT21"
)

# Intake and format variables
v2d <- read_csv("v2/DERIVE2_10.dat", col_names = TRUE)
v2d <- v2d[c(svar)]
v2d$V2DATE21 <- dmy(v2d$V2DATE21)

## Intake of V2 psychosocial metrics (Health and Life Profile).

# Social support
hpa2 <- read_csv("v2/HPAA.dat", col_names = TRUE)
hpa2$HPAA30 <- dmy(hpa2$HPAA30)

# Vital exhaustion
hpb2 <- read_csv("v2/HPBA.dat", col_names = TRUE)
hpb2$HPBA22 <- dmy(hpb2$HPBA22)

# Spielberger anger trait
hpc2 <- read_csv("v2/HPCA.dat", col_names = TRUE)
hpc2$HPCA11 <- dmy(hpc2$HPCA11)
```


## Visit 4 data

This is a prevalance data from the time of visit 4.

```{r}

## Derived variables from visit 4

# Selected variables.
svar <- c(
  "ID",
  "DRNKR41",
  "BMI41",
  "PRVCHD43",
  "MDDXMI41",
  "HXOFMI41",
  "DIABTS42",
  "ECGMI41",
  "PRVSTR41",
  "HYPERT45",
  "HYPTMD41",
  "CHOLMDCODE41",
  "V4AGE41",
  "V4DATE41",
  "PLAQUE42",
  "CIGT41"
)


v4d <- read_csv("v4/DERIVE46.dat", col_names = TRUE)
v4d <- v4d[c(svar)]
v4d$V4DATE41 <- dmy(v4d$V4DATE41)

## Psychosocial metric

# Spielberger anger trait at visit 4.
hpc4 <- read_csv("v4/HPCB04.dat", col_names = TRUE)
hpc4$HPCB11 <- dmy(hpc4$HPCB11)
```




## HRV data

This is a complicated data set of HRV files given to us by Eric Whitsel from the ARIC group. It has HRV data from visit 1 and from visit 4.

```{r}

## Data from HRV from visit 1, supine data.
hrv1 <- read_csv("hrv/f_hrv11b.dat", col_names = TRUE)

# Variables
svar <- c(
  "ID",
  "POSTV11",
  "QCFLGV11",
  "M_HRV11",
  "HFV11",
  "LFV11",
  "VLFV11",
  "TPV11",
  "PNN50V11",
  "MSSDV11",
  "SDNNV11"
)
hrv1 <- hrv1[c(svar)]

## HRV data from visit 4.
hrv4 <- read_csv("hrv/hrv_re4f.dat", col_names = TRUE)

# Selected variables
svar <- c(
  "ID",
  "postV4r",
  "qcflgv4R",
  "m_hrv4r",
  "HFv4r",
  "LFv4r",
  "VLFv4r",
  "tpV4r",
  "mssdV4r",
  "pnn50V4r",
  "sdnnV4r"
)
hrv4 <- hrv4[c(svar)]
```



## Outcomes data

An additional file of outcomes that were recorded (mainly death and associated ICD codes) along with if a cardiovascular event had occurred. This was updated for all patients up to the year 2015.

```{r}

# Read in table
outcomes <- read_csv("outcomes/inc_by15.dat", col_names = TRUE)

# Select and trim data frame
svar <- c(
  "ID",
  "C7_DATEMI",
  "C7_DATEPROC",
  "UCOD",
  "DATED15",
  "DEAD15"
)
outcomes <- outcomes[c(svar)]

outcomes$C7_DATEMI <- mdy(outcomes$C7_DATEMI)
outcomes$C7_DATEPROC <- mdy(outcomes$C7_DATEPROC)
outcomes$DATED15 <- dmy(outcomes$DATED15)

# Clean up outcomes
outcomes <- outcomes[c("ID", "C7_DATEMI", "UCOD", "DATED15", "DEAD15")]
names(outcomes) <- c("ID", "DATE_MI", "UCOD", "DATE_DEAD", "DEAD")
```

# TIDY

## Demographics

Creating a file that contains the basic demographic data of all patients along with their overall outcomes. The file is stored in *demo*, as a tidy tibble. 

```{r}
# Visit 1 prevalence
cs1 <- v1d

# BMI
cs1$BMI_1 <- round(cs1$BMI01, digits = 1)
cs1$BMI_1cat <- cut(cs1$BMI01,
  breaks = c(-Inf, 18.5, 25, 30, 35, 40, Inf),
  labels = c("underweight", "normal", "overweight", "obese_mild", "obese_moderate", "obese_severe")
)

# Diagnosis of hypertension, including treatment.
cs1$HTN_1 <- 0
cs1$HTN_1[v1d$HYPERT05 == 1 | v1d$HYPTMD01 == 1] <- 1

# Prior coronary artery disease by any known disease, MD decision, or ECG findings of Q waves.
cs1$CHD_1 <- 0
cs1$CHD_1[(v1d$PRVCHD05 | v1d$MDDXMI02 | v1d$HXOFMI02) == 1] <- 1

# Select variables
svar <- c("ID", "BIRTHDAT", "V1DATE01", "GENDER", "RACEGRP", "DRNKR01", "CIGT01", "BMI_1", "BMI_1cat", "HTN_1", "CHD_1", "DIABTS03")
cs1 <- cs1[c(svar)]
names(cs1) <- c("ID", "DATE_BIRTH", "DATE_V1", "GENDER", "RACE", "DRINKER", "SMOKER", "BMI", "BMI_cat", "HTN", "CHD", "DIABETES")


# Outcomes need to have diagnoses organized, they are a mix of ICD-9 and ICD-10 codes. If preceded with a letter, is an ICD-10 code, and if starts with a number, is an ICD-9 code (mainly). Using "ICD" package for help.

# ICD-9 set up
outcomes$ICD9 <- NA
outcomes$ICD9[as.icd9(outcomes$UCOD) %>% icd_is_valid()] <-
  outcomes$UCOD[as.icd9(outcomes$UCOD) %>% icd_is_valid()]

# ICD-10 set up
outcomes$ICD10 <- NA
outcomes$ICD10[as.icd10(outcomes$UCOD) %>% icd_is_valid()] <-
  outcomes$UCOD[as.icd10(outcomes$UCOD) %>% icd_is_valid()]

# Conversion into meaningful data with diagnosis groups
codes9 <- 
  icd9_comorbid_elix(outcomes, icd_name = "ICD9", visit_name = "ID", date_name = "DATE_DEAD") %>% 
  icd_comorbid_mat_to_df() %>% 
  as_tibble()
names(codes9)[1] <- "ID"

codes10 <-
  icd10_comorbid_elix(outcomes, icd_name = "ICD10", visit_name = "ID", date_name = "DATE_DEAD") %>%
  icd_comorbid_mat_to_df() %>%
  as_tibble()
names(codes10)[1] <- "ID"

# Melt these for merging
codes9 <- gather(codes9, variable, value, -ID)
codes10 <- gather(codes10, variable, value, -ID)

# Trim codes
codes9 <- codes9[codes9$value == TRUE, c("ID", "variable")]
codes10 <- codes10[codes10$value == TRUE, c("ID", "variable")]

# Merge codes
codes <- bind_rows(codes9, codes10)
names(codes) <- c("ID", "DX")
codes <- codes %>% group_by(ID) %>% filter(row_number() == 1)

# Merge the codes into outcomes
outcomes <- as_tibble(merge(outcomes, codes, by = "ID", all = TRUE))

# Demographic data: birthday, gender, race, prevalence of disease
# Combine this with the outcomes data
demo <- as_tibble(merge(cs1, outcomes, by = "ID"))

# Add ages
demo$AGE_ENROLL <- interval(demo$DATE_BIRTH, demo$DATE_V1) / years(1)
demo$AGE_DEATH <- interval(demo$DATE_BIRTH, demo$DATE_DEAD) / years(1)

# Convert to factors
demo <- within(demo, {
  ID <- factor(ID)

  GENDER <- factor(GENDER)
  levels(GENDER) <- c("Female", "Male")

  RACE <- factor(RACE)
  levels(RACE) <- c("Asian", "Black", "Unknown", "White")

  DRINKER <- factor(DRINKER)
  levels(DRINKER) <- c("Current", "Former", "Never", "Unknown")

  SMOKER <- factor(SMOKER)
  levels(SMOKER) <- c("Current", "Former", "Never", "Unknown")

  CHD <- factor(CHD)
  levels(CHD) <- c("Absent", "Present")

  DIABETES <- factor(DIABETES)
  levels(DIABETES) <- c("Absent", "Present")

  HTN <- factor(HTN)
  levels(HTN) <- c("Absent", "Present")

  DX <- factor(DX)
})
```

## Visit 2

### Cross-sectional covariate data

Limit the covariates to the most relevant, particularly prevalence of coronary artery disease (using myocardial ischemia or damage as the measurement). 

```{r}

## Visit 2 cross-sectional data

# Will need to include BMI, drinking status, coronary disease, diabetes, CVA, hypertension, smoking status
cs2 <- v2d

# BMI
cs2$BMI_2 <- round(cs2$BMI21, digits = 1)
cs2$BMI_2cat <- cut(cs2$BMI21,
  breaks = c(-Inf, 18.5, 25, 30, 35, 40, Inf),
  labels = c("underweight", "normal", "overweight", "obese_mild", "obese_moderate", "obese_severe")
)

# Diagnosis of hypertension, including treatment.
cs2$HTN_2 <- 0
cs2$HTN_2[v2d$HYPERT25 == 1 | v2d$HYPTMD21 == 1] <- 1

# Prior coronary artery disease by any known disease, MD decision, or ECG findings of Q waves.
cs2$CHD_2 <- 0
cs2$CHD_2[(v2d$PRVCHD21 | v2d$MDDXMI21 | v2d$ECGMI24) == 1] <- 1

svar <- c("ID", "V2DATE21", "V2AGE22", "DRNKR21", "CIGT21", "BMI_2", "BMI_2cat", "HTN_2", "CHD_2", "DIABTS23", "PRVSTR21")
cs2 <- as_tibble(cs2[c(svar)])
names(cs2) <- c("ID", "DATE_V2", "AGE_V2", "DRINKER", "SMOKER", "BMI", "BMI_cat", "HTN", "CHD", "DIABETES", "STROKE")

# Convert to factors
cs2 <- within(cs2, {
  ID <- factor(ID)

  DRINKER <- factor(DRINKER)
  levels(DRINKER) <- c("Current", "Former", "Never", "Unknown")

  SMOKER <- factor(SMOKER)
  levels(SMOKER) <- c("Current", "Former", "Never", "Unknown")

  CHD <- factor(CHD)
  levels(CHD) <- c("Absent", "Present")

  DIABETES <- factor(DIABETES)
  levels(DIABETES) <- c("Absent", "Present")

  HTN <- factor(HTN)
  levels(HTN) <- c("Absent", "Present")

  STROKE <- factor(STROKE)
  levels(STROKE) <- c("Absent", "Present")
})
```



### Psychosocial metrics

#### HPAA

The ISEL is scored from 0-3 points per question for 16-items, with the total ranging from 0-48 points (higher being more supportive). There are subscales, which are seen below as they map on to the HPAA questions.

Variable | Questions
--- | ---
AP | 7, 10, 14, 17 
TA | 8, 9, 13, 16
BE | 4, 5, 6, 11, 18
SE | 3, 12, 15

The LSNS is scored from 0-5 points for an 10-item questionnaire (the original form), with the total ranging from 0-50 points (higher more supportive). The subscales haven't been validated.

```{r}

# Select social support data
df <- hpa2

# ISEL is 3:18
# LSNS is 19:29

# ISEL variables
isel <- c("HPAA03", "HPAA04", "HPAA05", "HPAA06", "HPAA07", "HPAA08", "HPAA09", "HPAA10", "HPAA11", "HPAA12", "HPAA13", "HPAA14", "HPAA15", "HPAA16", "HPAA17", "HPAA18")

# LSNS variables
lsns <- c("HPAA19", "HPAA20", "HPAA21", "HPAA22", "HPAA23", "HPAA24", "HPAA25", "HPAA26", "HPAA27", "HPAA28", "HPAA29")

# Class of variables

# Trimmed HPAA data
df$placeholder <- NA
df <- df[c("ID", "placeholder", isel, lsns)]


# Create factors for ISEL
# Positive factors (higher score is better)
df[c(3, 6, 7, 8, 11, 12, 13, 14, 16, 18)] <-
  df[c(3, 6, 7, 8, 11, 12, 13, 14, 16, 18)] %>%
  mutate_all(funs(recode(., "A" = 0, "B" = 1, "C" = 2, "D" = 3)))

# Negative or reversed choices
df[c(4, 5, 9, 10, 15, 17)] <-
  df[c(4, 5, 9, 10, 15, 17)] %>%
  mutate_all(funs(recode(., "A" = 3, "B" = 2, "C" = 1, "D" = 0)))

# Create factors and scores for LSNS
df[c(19, 20, 21, 22, 23, 24)] <-
  df[c(19, 20, 21, 22, 23, 24)] %>%
  mutate_all(funs(recode(., "A" = 0, "B" = 1, "C" = 2, "D" = 3, "E" = 4, "F" = 5)))

df[c(25, 26)] <-
  df[c(25, 26)] %>%
  mutate_all(funs(recode(., "A" = 5, "B" = 4, "C" = 3, "D" = 2, "E" = 1, "F" = 0)))

df <- within(df, {
  HPAA27 <- recode(HPAA27, "A" = 1, "B" = 0)
  HPAA28 <- recode(HPAA28, "B" = 5, "C" = 4, "D" = 3, "E" = 2, "F" = 1)
  HPAA29 <- recode(HPAA29, "A" = 4, "B" = 3, "C" = 2, "D" = 1)
})

# Summarize data based on scale
df$ISEL <- rowSums(df[c(3:18)], na.rm = TRUE)
df$LSNS <- rowSums(df[c(19:29)], na.rm = TRUE)

# Summarize data with ISEL subscales
df$AP <- rowSums(df[c(7, 10, 14, 17)], na.rm = TRUE)
df$TA <- rowSums(df[c(8, 9, 13, 16)], na.rm = TRUE)
df$BE <- rowSums(df[c(4, 5, 6, 11, 18)], na.rm = TRUE)
df$SE <- rowSums(df[c(3, 12, 15)], na.rm = TRUE)

# Place data back
score_hpa2 <- df[c("ID", "ISEL", "LSNS", "AP", "TA", "BE", "SE")]
score_hpa2[-1] <-
  as_tibble(scale(score_hpa2[-1], center = TRUE), scale = TRUE)
```


#### HPBA

This is using the Maastricht Vital Exhaustion Questionnaire.

```{r}

# Maastrich data
# Don't know is considered NA
df <- hpb2

# HPBA variable set up (questions number align)
questions <- c("HPBA01", "HPBA02", "HPBA03", "HPBA04", "HPBA05", "HPBA06", "HPBA07", "HPBA08", "HPBA09", "HPBA10", "HPBA11", "HPBA12", "HPBA13", "HPBA14", "HPBA15", "HPBA16", "HPBA17", "HPBA18", "HPBA19", "HPBA20", "HPBA21")
df <- df[c(questions, "ID")]

# Mutate to scores
df[c(1:8, 10:13, 15:21)] <-
  df[c(1:8, 10:13, 15:21)] %>%
  mutate_all(funs(recode(., "Y" = 1, "N" = 0)))

# Reversed scores
df[c(9, 14)] <-
  df[c(9, 14)] %>%
  mutate_all(funs(recode(., "Y" = 0, "N" = 1)))

df$MAASTRICH <- rowSums(df[c(1:21)], na.rm = TRUE)

# Place data back
score_hpb2 <- df[c("ID", "MAASTRICH")]
score_hpb2[-1] <-
  as_tibble(scale(score_hpb2[-1], center = TRUE, scale = TRUE))
```



#### HPCB

This is using the Spielberger anger trait scale, which ranged in scores from 10 to 40. 

```{r}

# HPC2 data frame
df <- hpc2

# Create data frame from Spielberger, trimmed down
questions <- c("HPCA01", "HPCA02", "HPCA03", "HPCA04", "HPCA05", "HPCA06", "HPCA07", "HPCA08", "HPCA09", "HPCA10")
df <- df[c(questions, "ID")]

# Mutate scores, with low = 1, high = 4
df[c(1:10)] <-
  df[c(1:10)] %>%
  mutate_all(funs(recode(., "A" = 1, "B" = 2, "C" = 3, "D" = 4)))

# Create total score
df$SPIELBERGER <- rowSums(df[c(1:10)], na.rm = TRUE)

# Create strata defined as high = [22, 40], mid = [15, 21], low = [10,14]
# Variable "anger_level" shows the three strata (low = 1, mid = 2, high = 3)

df$anger_level <- 1
df$anger_level[df$SPIELBERGER >= 15] <- 2
df$anger_level[df$SPIELBERGER >= 22] <- 3

# Confirm data frame, scaling for normality
score_hpc2 <- df[c("ID", "SPIELBERGER", "anger_level")]
score_hpc2[-c(1, 3)] <-
  as_tibble(scale(score_hpc2[-c(1, 3)], center = TRUE, scale = TRUE))
```

### HRV metrics (collected at visit 1)

This is the 2 minute data collection done supine. 

```{r}

# Visit 1 HRV data
df <- hrv1

# Variables and data trim
svar <- c(
  "ID",
  "M_HRV11",
  "HFV11",
  "LFV11",
  "VLFV11",
  "TPV11",
  "PNN50V11",
  "MSSDV11",
  "SDNNV11"
)
df <- df[c("QCFLGV11", svar)]

# Only "quality" data
df <- df[df$QCFLGV11 != 1, svar]

# Rename the columns for ease of use
names(df) <- c("ID", "BPM", "HF", "LF", "VLF", "TP", "PNN50", "RMSSD", "SDNN")

# Only quality HRV data
hrv1 <- df

# Will need to transform the data prior to utilization
# Cube root to avoid the zero issues and negatives for scaling
z_hrv1 <-
  hrv1 %>%
  mutate_at(
    function(x) {
      sign(x) * abs(x)^(1 / 3)
      (x - mean(x)) / sd(x)
    },
    .vars = vars(-ID)
  )
```


## Visit 4

### Cross sectional data

Adjusted multiple variables for more meaningful interpretation.

```{r}

# Make cross sectional data table
cs4 <- v4d

# Fix BMI
cs4$BMI_4 <- round(cs4$BMI41, digits = 1)
cs4$BMI_4cat <- cut(cs4$BMI41,
  breaks = c(-Inf, 18.5, 25, 30, 35, 40, Inf),
  labels = c("underweight", "normal", "overweight", "obese_mild", "obese_moderate", "obese_severe")
)

# Fix hypertension
cs4$HTN_4 <- 0
cs4$HTN_4[v4d$HYPERT45 == 1 | v4d$HYPTMD41 == 1] <- 1

# Prior coronary artery disease by any known disease, MD decision, or ECG findings of Q waves.
cs4$CHD_4 <- 0
cs4$CHD_4[(v4d$PRVCHD43 | v4d$MDDXMI41 | v4d$ECGMI41) == 1] <- 1

# Select variables
svar <- c("ID", "V4AGE41", "V4DATE41", "DRNKR41", "CIGT41", "CHD_4", "HTN_4", "BMI_4", "BMI_4cat", "DIABTS42", "PRVSTR41")
cs4 <- cs4[c(svar)]
names(cs4) <- c("ID", "AGE_V4", "DATE_V4", "DRINKER", "SMOKER", "CHD", "HTN", "BMI", "BMI_cat", "DIABETES", "STROKE")

# Convert to factors
cs4 <- within(cs4, {
  ID <- factor(ID)

  DRINKER <- factor(DRINKER)
  levels(DRINKER) <- c("Current", "Former", "Never", "Unknown")

  SMOKER <- factor(SMOKER)
  levels(SMOKER) <- c("Current", "Former", "Never", "Unknown")

  CHD <- factor(CHD)
  levels(CHD) <- c("Absent", "Present")

  DIABETES <- factor(DIABETES)
  levels(DIABETES) <- c("Absent", "Present")

  HTN <- factor(HTN)
  levels(HTN) <- c("Absent", "Present")

  STROKE <- factor(STROKE)
  levels(STROKE) <- c("Absent", "Present")
})
```

### Psychosocial metric

#### HPCB

```{r}

# HPCB data frame from visit 4
df <- hpc4

# Create data frame from Maastrich, trimmed down
questions <- c("HPCB01", "HPCB02", "HPCB03", "HPCB04", "HPCB05", "HPCB06", "HPCB07", "HPCB08", "HPCB09", "HPCB10")
df <- df[c(questions, "ID")]

# Mutate scores, with low = 1, high = 4
df[c(1:10)] <-
  df[c(1:10)] %>%
  mutate_all(funs(recode(., "A" = 1, "B" = 2, "C" = 3, "D" = 4)))

# Create total score
df$SPIELBERGER <- rowSums(df[c(1:10)], na.rm = TRUE)

# Create strata defined as high = [22, 40], mid = [15, 21], low = [10,14]
# Variable "anger_level" shows the three strata (low = 1, mid = 2, high = 3)

df$anger_level <- 1
df$anger_level[df$SPIELBERGER >= 15] <- 2
df$anger_level[df$SPIELBERGER >= 22] <- 3

# Confirm data frame
score_hpc4 <- df[c("ID", "SPIELBERGER", "anger_level")]
score_hpc4[-c(1, 3)] <-
  as_tibble(scale(score_hpc4[-c(1, 3)], center = TRUE, scale = TRUE))
```

### HRV metrics

HRV collected at visit 4 was supine and lasted about 6 minutes.

```{r}

# Select data frame
df <- hrv4

# Variable selection
svar <- c(
  "ID",
  "m_hrv4r",
  "HFv4r",
  "LFv4r",
  "VLFv4r",
  "tpV4r",
  "pnn50V4r",
  "mssdV4r",
  "sdnnV4r"
)
df <- df[c("qcflgv4R", svar)]

# Only quality data
df <- df[df$qcflgv4R != 1, svar]

# Rename variables
names(df) <- c("ID", "BPM", "HF", "LF", "VLF", "TP", "PNN50", "RMSSD", "SDNN")

# Final data frame
hrv4 <- df

# Will need to transform the data prior to utilization
# Cube root to avoid the zero issues and negatives for scaling
z_hrv4 <-
  hrv4 %>%
  na.omit() %>%
  mutate_at(
    function(x) {
      sign(x) * abs(x)^(1 / 3)
      (x - mean(x)) / sd(x)
    },
    .vars = vars(-ID)
  )
```

## Clean up

```{r}

# Clean data frames are tibbles
demo <- as_tibble(demo)
cs1 <- as_tibble(cs1)
cs2 <- as_tibble(cs2)
cs4 <- as_tibble(cs4)
hpa2 <- as_tibble(hpa2)
hpb2 <- as_tibble(hpb2)
hpc2 <- as_tibble(hpc2)
hpc4 <- as_tibble(hpc4)
hrv1 <- as_tibble(hrv1)
hrv4 <- as_tibble(hrv4)

# Clean up of memory-clogging junk
rm(df, outcomes, questions, svar, v1d, v2d, v4d)
```


# MODEL

The data has been tidied up to this point. The current variables are...

Variable | Description
--- | ---
demo | Overall sample description, including death
cs2 | Prevalence of disease at V2
cs4 | Prevalence of disease at V4
hpa2 | ISEL and LSNS scores at V2
hpb2 | Maastricht vital exhaustion at V2
hpc2 | Spielberger Anger at V2
hpc4 | Spielberger Anger at V4
score_hp* | Numeric scaling of psychosocial scores
hrv1 | 2-minute HRV data from V1
hrv4 | 6-minute HRV data from V4

## Understand
### Understand demographics

Of the relevant variables, there is changes in prevalence and population over time. 

#### Visit 1

Visit 1 also has the outcomes data, and serves as a map for all patients throughout the study.

```{r}

# Data frame made above, is demographics and outcomes
df <- as.data.frame(demo)

# Relevant variables include ID, age at entry, age at death
char_v1 <- compareGroups(~ AGE_ENROLL + GENDER + RACE + DRINKER + SMOKER + BMI, data = df)

char_v1_tbl <- createTable(char_v1, show.n = FALSE, show.ratio = FALSE, show.p.ratio = FALSE, show.p.overall = FALSE)
export2latex(char_v1_tbl, caption = "Description of ARIC population")
```


#### Visit 2

```{r}

# Data from for visit 2
df <- as.data.frame(cs2)

# Descriptions of V2 characteristics
char_v2 <- compareGroups(~ HTN + CHD + DIABETES + STROKE, data = df)

char_v2_tbl <- createTable(char_v2, show.n = FALSE, show.ratio = FALSE, show.p.ratio = FALSE, show.p.overall = FALSE)
export2latex(char_v2_tbl, caption = "Description of ARIC population")
```

#### Visit 4

```{r}

# Data from for visit 4
df <- as.data.frame(cs4)

# Descriptions of V4 characteristics
char_v4 <- compareGroups(~ HTN + CHD + DIABETES + STROKE, data = df)

char_v4_tbl <- createTable(char_v4, show.n = FALSE, show.ratio = FALSE, show.p.ratio = FALSE, show.p.overall = FALSE)
export2latex(char_v4_tbl, caption = "Description of ARIC population")
```


### Understand psychosocial metrics

#### ISEL and LSNS

```{r}

# Looking at scores from ISEL and subgroups
df <-
  score_hpa2[c("ID", "LSNS", "ISEL", "AP", "TA", "BE", "SE")] %>%
  gather(variable, value, -ID)

# ISEL normality
# Visualize the overall score distribution
# Mostly normal, slightly skewed
gDistributionInterpersonal <-
  ggplot(df[df$variable == "ISEL", ], aes(x = value)) +
  geom_histogram(binwidth = 1) +
  labs(
    title = "Distribution of ISEL total score",
    x = "Score",
    y = "Frequency"
  ) +
  theme_minimal()

# Visualize distribution of subscales
# Have variety of scews, do not "appear" normal
gDistributionInterpersonalSubscales <-
  ggplot(df[df$variable != "ISEL" & df$variable != "LSNS", ], aes(x = value, y = variable)) +
  geom_density_ridges2(aes(fill = variable), stat = "binline", binwidth = 1, colour = "white", scale = 1.6) +
  labs(
    title = "Distribution of ISEL subscales",
    x = "Points",
    y = "Frequency"
  ) +
  guides(fill = FALSE) +
  scale_fill_ptol() +
  theme_minimal()

# Lubben scale
# Visualize the overall score distribution
# Normalized distribution
gDistributionLubben <-
  ggplot(df[df$variable == "LSNS", ], aes(x = value)) +
  geom_histogram(aes(y = ..count.. / sum(..count..)), binwidth = 1) +
  labs(
    title = "Distribution of LSNS total score",
    x = "Score",
    y = "Frequency"
  ) +
  scale_y_continuous(labels = percent) +
  theme_minimal()
```


#### Maastrich Vital Exhaustion Scale

```{r}

# Overall Maastrich data frame
df <-
  score_hpb2 %>%
  gather(variable, value, -ID)

# Visualization
gDistributionMaastrich <-
  ggplot(df, aes(x = value)) +
  geom_histogram(aes(y = ..count.. / sum(..count..)), binwidth = 1) +
  labs(
    title = "Distribution of Maastrich Exhaustion Scale",
    x = "Score",
    y = "Frequency"
  ) +
  scale_y_continuous(labels = percent) +
  theme_minimal()
  
```


#### Spielberger Anger Trait Scale at visit 2

```{r}

# Overall Spielberger at V2
df <- score_hpc2

gDistributionSpielbergerV2 <-
  ggplot(df, aes(x = SPIELBERGER, fill = factor(anger_level))) +
  geom_histogram(aes(y = ..count../sum(..count..)), binwidth = 0.5) +
  labs(
    title = "Distribution of Spielberger Anger Trait Scale [V2]",
    x = "Score",
    y = "Frequency",
    fill = "Anger Level"
  ) +
  scale_y_continuous(label = percent) +
  scale_fill_ptol() + 
  theme_minimal()
```

#### Spielberger Anger Trait Scale at visit 4

```{r}

# Overall Spielberger at V2
df <- score_hpc4

gDistributionSpielbergerV4 <-
  ggplot(df, aes(x = SPIELBERGER, fill = factor(anger_level))) +
  geom_histogram(aes(y = ..count.. / sum(..count..)), binwidth = 0.5) +
  labs(
    title = "Distribution of Spielberger Anger Trait Scale [V4]",
    x = "Score",
    y = "Frequency",
    fill = "Anger Level"
  ) +
  scale_y_continuous(label = percent) +
  scale_fill_ptol() +
  theme_minimal()
```

#### Correlation of psychosocial metrics

```{r}

# Data frame of all psychosocial metrics
tmp <- merge(score_hpa2, score_hpb2, by = "ID")
df <- merge(tmp, score_hpc2, by = "ID")

# Correlation plot
correlation_plot_psychosocial_v2 <-
  ggcorr(df[-1], nbreaks = 10, palette = "BrBG", label = TRUE)
```


### Understand HRV data 

#### Pattern at visit 1

```{r}

# Make a long format of variables for visualization
df <- hrv1 %>% gather(variable, value, -ID)

# Visualize each distribution pattern
gDistributionHRV1 <-
  ggplot(df, aes(x = value, fill = variable)) +
  facet_wrap(~ variable, ncol = 3, scales = "free") +
  geom_histogram(aes(y = ..count.. / sum(..count..))) +
  scale_y_continuous(labels = percent) +
  scale_fill_ptol() +
  labs(
    title = "Distribution of untransformed HRV [V1]",
    x = "Values",
    y = "Frequency (percent)"
  ) +
  guides(fill = FALSE) +
  theme_minimal()

# Normalized long table
df <- z_hrv1 %>% gather(variable, value, -ID)

# Ridge plots after normalization
gRidgesHRV1 <-
  ggplot(df, aes(x = value, y = variable)) +
  geom_density_ridges2(aes(fill = variable), colour = "white", scale = 1.3) +
  scale_fill_ptol() +
  xlim(-3, 3) +
  labs(
    title = "Distribution of HRV after normalization at V1",
    x = "Values after cube root and z-normalization",
    y = "HRV measures distribution"
  ) +
  guides(fill = FALSE) +
  theme_minimal()

# Correlation tests
df <- z_hrv1[-1]
correlation_plot_hrv_v1 <-
  ggcorr(df, nbreaks = 10, palette = "BrBG", label = TRUE)
```


#### Pattern at visit 4

```{r}

# Make a long format of variables for visualization
df <- hrv4 %>% gather(variable, value, -ID)

# Visualize each distribution pattern
gDistributionHRV4 <-
  ggplot(df, aes(x = value, fill = variable)) +
  facet_wrap(~ variable, ncol = 3, scales = "free") +
  geom_histogram(aes(y = ..count.. / sum(..count..))) +
  scale_y_continuous(labels = percent) +
  scale_fill_ptol() +
  labs(
    title = "Distribution of untransformed HRV [V4]",
    x = "Values",
    y = "Frequency (percent)"
  ) +
  guides(fill = FALSE) + 
  theme_minimal()

# Normalized long table
df <- z_hrv4 %>% gather(variable, value, -ID)

# Ridge plots after normalization
gRidgesHRV4 <-
  ggplot(df, aes(x = value, y = variable)) +
  geom_density_ridges2(aes(fill = variable), colour = "white", scale = 1.3) +
  scale_fill_ptol() +
  xlim(-3, 3) +
  labs(
    title = "Distribution of HRV after normalization at V4",
    x = "Values after cube root and z-normalization",
    y = "HRV measures distribution"
  ) +
  guides(fill = FALSE) +
  theme_minimal()

# Correlation tests
df <- z_hrv4[-1]
correlation_plot_hrv_v4 <-
  ggcorr(df, nbreaks = 10, palette = "BrBG", label = TRUE)
```



## Relationships

### Visit 2 relationships

```{r}

# Data frame for V2
df <-
  merge(score_hpa2, score_hpb2, by = "ID") %>%
  merge(., score_hpc2, by = "ID") %>%
  gather(psych_variable, psych_value, -ID) %>%
  merge(., gather(z_hrv1, hrv_variable, hrv_value, -ID), by = "ID") %>%
  as_tibble()

# Create selection variables
df$psych_variable <- factor(df$psych_variable)
df$hrv_variable <- factor(df$hrv_variable)

# Create combination column as an identifier
df$combination <- paste(df$psych_variable, df$hrv_variable)

# Create combinatorial model
lm_v2 <-
  df %>%
  group_by(psych_variable, hrv_variable) %>%
  do(
    model =
      lm(.$psych_value ~ .$hrv_value, data = .)
  )

# Summarize the model and extract ocefficients
lm_v2$model_sum <- map(lm_v2$model, summary)
lm_v2$pvalue <-
  as.numeric(map(lm_v2$model_sum, function(x) {
    x$coefficients[2, 4]
  }))
lm_v2$rsquare <-
  as.numeric(map(lm_v2$model_sum, function(x) {
    x$r.squared
  }))

# Select only the significant models
lm_sig <- lm_v2[lm_v2$pvalue < .05, ]
lm_sig$combination <- paste(lm_sig$psych_variable, lm_sig$hrv_variable)

# Visualize regressions
gRegressionsV1 <-
  ggplot(df[df$combination %in% lm_sig$combination, ], aes(x = hrv_value, y = psych_value, colour = psych_variable)) +
  facet_wrap(~ hrv_variable, scales = "free", ncol = 3) +
  geom_smooth(method = "lm", se = TRUE) +
  xlim(-3, 3) +
  labs(
    title = "Linear regressions of Psych ~ HRV at Visit 2",
    x = "Normalized HRV",
    y = "Normalized Psych Scores [SEM]",
    colour = "Psychosocial Measures",
    caption = "Significant correlations of HRV with psychosocial measures is visualized above."
  ) +
  scale_colour_ptol() +
  theme_minimal()
```

### Visit 4 Relationship

```{r}

# Data from visit 4
df <-
  score_hpc4 %>%
  gather(psych_variable, psych_value, -ID) %>%
  merge(., gather(z_hrv4, hrv_variable, hrv_value, -ID)) %>%
  as_tibble()

# Create identifying variables
df$psych_variable <- factor(df$psych_variable)
df$hrv_variable <- factor(df$hrv_variable)
df$combination <- paste(df$psych_variable, df$hrv_variable)

# Create combinatorial model
lm_v4 <-
  df %>%
  group_by(psych_variable, hrv_variable) %>%
  do(
    model =
      lm(.$psych_value ~ .$hrv_value, data = .)
  )

# Summarize the model and extract ocefficients
lm_v4$model_sum <- map(lm_v4$model, summary)
lm_v4$pvalue <-
  as.numeric(map(lm_v4$model_sum, function(x) {
    x$coefficients[2, 4]
  }))
lm_v4$rsquare <-
  as.numeric(map(lm_v4$model_sum, function(x) {
    x$r.squared
  }))

# Select only the significant models
lm_sig <- lm_v4[lm_v4$pvalue < .05, ]
lm_sig$combination <- paste(lm_sig$psych_variable, lm_sig$hrv_variable)

# Visualize regressions
gRegressionsV4 <-
  ggplot(df[df$combination %in% lm_sig$combination, ], aes(x = hrv_value, y = psych_value, colour = psych_variable)) +
  facet_wrap(~ hrv_variable, scales = "free", ncol = 2) +
  geom_smooth(method = "lm", se = TRUE) +
  xlim(-3, 3) +
  labs(
    title = "Linear regressions of Psych ~ HRV at Visit 4",
    x = "Normalized HRV",
    y = "Normalized Psych Scores [SEM]",
    colour = "Psychosocial Measures"
  ) +
  scale_colour_ptol() +
  theme_minimal()
```


## Survival analysis

### Kaplan-Meier survival curve

```{r}

# Data frame formated for survival objects
df <- demo

# Survival curve fit
fit <- survfit(Surv(AGE_DEATH, DEAD, type = c("right")) ~ 1, data = df)

# Visualize survival curve
km_overall <- ggsurvplot(
  fit, 
  conf.int = TRUE, 
  risk.table = "percentage",
  xlim = c(50, 95),
  break.time.by = 5,
  surv.median.line = "hv",
  ggtheme = theme_minimal(),
  palette = ptol_pal()(1),
  xlab = "Time in years",
  title = "ARIC Survival Curve")
           
```

### Cox proportional hazards

#### HRV

```{r}

# Data needed for survival objects
df <- as_tibble(merge(demo, z_hrv1, by = "ID"))

# Cox regression formula
cox_hrv <- coxph(Surv(AGE_DEATH, DEAD) ~ BPM + HF + LF + VLF + TP + PNN50 + RMSSD + SDNN, data = df)

# Check for residual
cox.zph(cox_hrv)
residuals(cox_hrv, type = "scaledsch")


```

#### Psychosocial measures

```{r}

# Data needed for survival objectsi
df <-
  score_hpa2 %>%
  merge(., score_hpb2, by = "ID") %>%
  merge(., score_hpc2, by = "ID") %>%
  merge(., demo, by = "ID") %>%
  as_tibble()

# Cox model
cox_psych <- coxph(Surv(AGE_DEATH, DEAD) ~ ISEL + LSNS + AP + TA + BE + SE + MAASTRICH + SPIELBERGER + anger_level, data = df)
```

# REPORT


# CONCLUSION

```{r}

# Time needed to process entire script
proc.time() - start_time
```



